# Stainless formalization of the bundle closure algorithm.

See: https://github.com/opencaesar/owl-tools/tree/master/owl-close-world

## Using stainless to improve the specification.

### [v1 commit](https://github.com/NicolasRouquette/stainless-bundle-closure/tree/v1)

<details>
<summary>Details</summary>

This is the initial version converted from Java.
Stainless finds a few interesting things:

```scala
  def intersection(e: ClassExpression): ClassExpression = // VC 'non-negative measure' @ 18:7: VALID
    if (this == e)
      this
    else e match {
      case Universal =>
        e.intersection(this) // VC 'measure decreases' @ 23:23: INVALID
      case _: Intersection =>
        e.intersection(this) // VC 'measure decreases' @ 25:23: VALID
      case Empty =>
        e.intersection(this) // VC 'measure decreases' @ 27:23: INVALID
      case _ =>
        Intersection(Cons(this, Cons(e, Nil())))
    }
```

The problem here is that these methods need to be written in an inductive style
where, in some sense, the different paths in the function result in a measurable
decrease in terms of the "size" of the object that the function is applied to.

With a conventional object-oriented style, this measurable decrease does not hold
because in effect these methods are "constructors" for building composite objects
from simpler ones.

</details>

### [v2 commit](https://github.com/NicolasRouquette/stainless-bundle-closure/tree/v2)

<details>
<summary>Details</summary>

This refactoring eliminates the stainless errors; however,
without additional annotations, stainless can't verify much about this code.

</details>

### [v3 commit](https://github.com/NicolasRouquette/stainless-bundle-closure/tree/v3)

<details>
<summary>Details</summary>

Ported more of the original machinery to Scala.
Next: A Stainless version of the heart of the closure algorithm: [DirectedGraph](https://github.com/opencaesar/owl-tools/blob/master/owl-close-world/src/main/java/io/opencaesar/closeworld/DirectedGraph.java)

</details>

### [v4 commit](https://github.com/NicolasRouquette/stainless-bundle-closure/tree/v4)

<details>
<summary>Details</summary>

Encoding of a simple directed graph library in stainless.

Error:

```
sbt:bundle-closure> compile
[info] Compiling 37 Scala sources to /home/rouquette/Desktop/stainless/bundle-closure/verified/target/scala-2.12/classes ...
[warn] The Z3 native interface is not available. Falling back onto smt-z3.
[info] Generating VCs for those functions: set$0
[info] Generating VCs for those functions: $init$0
[info] Generating VCs for those functions: complement$0, complement$1, complement$2, complement$3, complement$4, complement$5, complement$6
[info] Checking Verification Conditions...
[info]  - Checking cache: 'precond. (call complement(@unchecked {   assert(this...)' VC for complement @61:7...
[info] Cache hit: 'precond. (call complement(@unchecked {   assert(this...)' VC for complement @61:7...
[info]  - Checking cache: 'precond. (call complement(@unchecked {   assert(this...)' VC for complement @61:7...
[info] Cache hit: 'precond. (call complement(@unchecked {   assert(this...)' VC for complement @61:7...
[info]  - Checking cache: 'precond. (call complement(@unchecked {   assert(this...)' VC for complement @61:7...
[info] Cache hit: 'precond. (call complement(@unchecked {   assert(this...)' VC for complement @61:7...
[info]  - Checking cache: 'precond. (call complement(@unchecked {   assert(this...)' VC for complement @61:7...
[info] Cache hit: 'precond. (call complement(@unchecked {   assert(this...)' VC for complement @61:7...
[info]  - Checking cache: 'precond. (call complement(@unchecked {   assert(this...)' VC for complement @61:7...
[info] Cache hit: 'precond. (call complement(@unchecked {   assert(this...)' VC for complement @61:7...
[info]  - Checking cache: 'precond. (call complement(@unchecked {   assert(this...)' VC for complement @61:7...
[info] Cache hit: 'precond. (call complement(@unchecked {   assert(this...)' VC for complement @61:7...
[info]   - Inferring measure for size...
[info]  => Found measure for size.
[info]   - Inferring measure for forall...
[info]  => Found measure for forall.
[info]   - Inferring measure for noDuplicate...
[info]  => Found measure for noDuplicate.
[info]   - Inferring measure for map...
[info]  => Found measure for map.
[info] Generating VCs for those functions: inv$2
[info] Generating VCs for those functions: difference$0, difference$1, difference$2, difference$3, difference$4, difference$5, difference$6
[info] Checking Verification Conditions...
[info]  - Checking cache: 'precond. (call difference(@unchecked {   assert(this...)' VC for difference @62:7...
[info] Cache hit: 'precond. (call difference(@unchecked {   assert(this...)' VC for difference @62:7...
[info]  - Checking cache: 'precond. (call difference(@unchecked {   assert(this...)' VC for difference @62:7...
[info] Cache hit: 'precond. (call difference(@unchecked {   assert(this...)' VC for difference @62:7...
[info]  - Checking cache: 'precond. (call difference(@unchecked {   assert(this...)' VC for difference @62:7...
[info] Cache hit: 'precond. (call difference(@unchecked {   assert(this...)' VC for difference @62:7...
[info]  - Checking cache: 'precond. (call difference(@unchecked {   assert(this...)' VC for difference @62:7...
[info] Cache hit: 'precond. (call difference(@unchecked {   assert(this...)' VC for difference @62:7...
[info]  - Checking cache: 'precond. (call difference(@unchecked {   assert(this...)' VC for difference @62:7...
[info] Cache hit: 'precond. (call difference(@unchecked {   assert(this...)' VC for difference @62:7...
[info]  - Checking cache: 'precond. (call difference(@unchecked {   assert(this...)' VC for difference @62:7...
[info] Cache hit: 'precond. (call difference(@unchecked {   assert(this...)' VC for difference @62:7...
[info]  - Checking cache: 'match exhaustiveness' VC for difference @167:9...
[info] Cache hit: 'match exhaustiveness' VC for difference @167:9...
[info]  - Checking cache: 'match exhaustiveness' VC for difference @285:9...
[info] Cache hit: 'match exhaustiveness' VC for difference @285:9...
[info]  - Checking cache: 'match exhaustiveness' VC for difference @233:9...
[info] Cache hit: 'match exhaustiveness' VC for difference @233:9...
[info]  - Checking cache: 'match exhaustiveness' VC for difference @115:9...
[info] Cache hit: 'match exhaustiveness' VC for difference @115:9...
[info] Generating VCs for those functions: vertices$0
[info] Checking Verification Conditions...
[info]  - Checking cache: 'postcondition' VC for vertices @13:7...
[info] Cache hit: 'postcondition' VC for vertices @13:7...
[info]   - Inferring measure for -...
[info]  => Found measure for -.
[info]   - Inferring measure for unique...
[info]  => Found measure for unique.
[info]   - Inferring measure for ++...
[info]  => Found measure for ++.
[info] Generating VCs for those functions: union$0, union$1, union$2, union$3, union$4, union$5, union$6, union$7
[info] Checking Verification Conditions...
[info]  - Checking cache: 'precond. (call union(@unchecked {   assert(thiss is ...)' VC for union @64:7...
[info] Cache hit: 'precond. (call union(@unchecked {   assert(thiss is ...)' VC for union @64:7...
[info]  - Checking cache: 'precond. (call union(@unchecked {   assert(thiss is ...)' VC for union @64:7...
[info] Cache hit: 'precond. (call union(@unchecked {   assert(thiss is ...)' VC for union @64:7...
[info]  - Checking cache: 'precond. (call union(@unchecked {   assert(thiss is ...)' VC for union @64:7...
[info] Cache hit: 'precond. (call union(@unchecked {   assert(thiss is ...)' VC for union @64:7...
[info]  - Checking cache: 'precond. (call union(@unchecked {   assert(thiss is ...)' VC for union @64:7...
[info] Cache hit: 'precond. (call union(@unchecked {   assert(thiss is ...)' VC for union @64:7...
[info]  - Checking cache: 'precond. (call union(@unchecked {   assert(thiss is ...)' VC for union @64:7...
[info] Cache hit: 'precond. (call union(@unchecked {   assert(thiss is ...)' VC for union @64:7...
[info]  - Checking cache: 'precond. (call union(@unchecked {   assert(thiss is ...)' VC for union @64:7...
[info] Cache hit: 'precond. (call union(@unchecked {   assert(thiss is ...)' VC for union @64:7...
[info]  - Checking cache: 'precond. (call union(@unchecked {   assert(thiss is ...)' VC for union @64:7...
[info] Cache hit: 'precond. (call union(@unchecked {   assert(thiss is ...)' VC for union @64:7...
[info]  - Checking cache: 'match exhaustiveness' VC for union @267:16...
[info] Cache hit: 'match exhaustiveness' VC for union @267:16...
[info]  - Checking cache: 'match exhaustiveness' VC for union @149:16...
[info] Cache hit: 'match exhaustiveness' VC for union @149:16...
[info]  - Checking cache: 'match exhaustiveness' VC for union @354:9...
[info] Cache hit: 'match exhaustiveness' VC for union @354:9...
[info]  - Checking cache: 'match exhaustiveness' VC for union @324:16...
[info] Cache hit: 'match exhaustiveness' VC for union @324:16...
[info]  - Checking cache: 'match exhaustiveness' VC for union @205:9...
[info] Cache hit: 'match exhaustiveness' VC for union @205:9...
[info] Generating VCs for those functions: a$0, b$0, s$0
[info] Generating VCs for those functions: intersection$0, intersection$1, intersection$2, intersection$3, intersection$4, intersection$5, intersection$6, intersection$7
[info] Checking Verification Conditions...
[info]  - Checking cache: 'precond. (call intersection(@unchecked {   assert(th...)' VC for intersection @63:7...
[info] Cache hit: 'precond. (call intersection(@unchecked {   assert(th...)' VC for intersection @63:7...
[info]  - Checking cache: 'precond. (call intersection(@unchecked {   assert(th...)' VC for intersection @63:7...
[info] Cache hit: 'precond. (call intersection(@unchecked {   assert(th...)' VC for intersection @63:7...
[info]  - Checking cache: 'precond. (call intersection(@unchecked {   assert(th...)' VC for intersection @63:7...
[info] Cache hit: 'precond. (call intersection(@unchecked {   assert(th...)' VC for intersection @63:7...
[info]  - Checking cache: 'precond. (call intersection(@unchecked {   assert(th...)' VC for intersection @63:7...
[info] Cache hit: 'precond. (call intersection(@unchecked {   assert(th...)' VC for intersection @63:7...
[info]  - Checking cache: 'precond. (call intersection(@unchecked {   assert(th...)' VC for intersection @63:7...
[info] Cache hit: 'precond. (call intersection(@unchecked {   assert(th...)' VC for intersection @63:7...
[info]  - Checking cache: 'precond. (call intersection(@unchecked {   assert(th...)' VC for intersection @63:7...
[info] Cache hit: 'precond. (call intersection(@unchecked {   assert(th...)' VC for intersection @63:7...
[info]  - Checking cache: 'precond. (call intersection(@unchecked {   assert(th...)' VC for intersection @63:7...
[info] Cache hit: 'precond. (call intersection(@unchecked {   assert(th...)' VC for intersection @63:7...
[info]  - Checking cache: 'match exhaustiveness' VC for intersection @134:16...
[info] Cache hit: 'match exhaustiveness' VC for intersection @134:16...
[info]  - Checking cache: 'match exhaustiveness' VC for intersection @186:9...
[info] Cache hit: 'match exhaustiveness' VC for intersection @186:9...
[info]  - Checking cache: 'match exhaustiveness' VC for intersection @307:16...
[info] Cache hit: 'match exhaustiveness' VC for intersection @307:16...
[info]  - Checking cache: 'match exhaustiveness' VC for intersection @342:16...
[info] Cache hit: 'match exhaustiveness' VC for intersection @342:16...
[info]  - Checking cache: 'match exhaustiveness' VC for intersection @252:16...
[info] Cache hit: 'match exhaustiveness' VC for intersection @252:16...
[info]   - Inferring measure for find...
[info]  => Found measure for find.
[info] Generating VCs for those functions: next$0
[info] Checking Verification Conditions...
[info]  - Checking cache: 'precond. (call pop[V](thiss))' VC for next @39:21...
[info] Cache hit: 'precond. (call pop[V](thiss))' VC for next @39:21...
[info]  - Checking cache: 'precond. (call pop[V](thiss))' VC for next @39:21...
[info] Cache hit: 'precond. (call pop[V](thiss))' VC for next @39:21...
[info]  - Checking cache: 'match exhaustiveness' VC for next @39:9...
[info] Cache hit: 'match exhaustiveness' VC for next @39:9...
[info]  - Checking cache: 'adt invariant' VC for next @42:20...
[info] Cache miss: 'adt invariant' VC for next @42:20...
[info]  - Now solving 'adt invariant' VC for next @42:20...
[info] ¬hasNext[V](thiss) || ¬wff[V](thiss.g.adjascent) || {
[info]   val x$1: (V, DFSIterator[V]) = (pop[V](thiss)._1, pop[V](thiss)._2)
[info]   val n: DFSIterator[V] = pop[V](thiss)._2
[info]   val vss: List[V] = ++[V](n.stack, childrenOf[V](n.g, pop[V](thiss)._1))
[info]   wff[V](n.g.adjascent) && includesAll[V](n.g.adjascent, vss) && includesAll[V](n.g.adjascent, n.toVisit) && noDuplicate[V](n.toVisit) && forall[V](vss, (v: V) => contains[V](n.toVisit, v))
[info] }
[info] Solving with: U:smt-z3
[error] Error: List() (of class scala.collection.immutable.Nil$). Trace:
[error] - stainless.verification.VerificationChecker.checkAdtInvariantModel(VerificationChecker.scala:150)
[error] - stainless.verification.VerificationChecker.checkAdtInvariantModel$(VerificationChecker.scala:147)
[error] - stainless.verification.VerificationChecker$Checker$1.checkAdtInvariantModel(VerificationChecker.scala:336)
[error] - stainless.verification.VerificationChecker.checkVC(VerificationChecker.scala:256)
[error] - stainless.verification.VerificationChecker.checkVC$(VerificationChecker.scala:214)
[error] - stainless.verification.VerificationChecker$$anon$1.stainless$verification$VerificationCache$$super$checkVC(VerificationChecker.scala:345)
[error] - stainless.verification.VerificationCache.$anonfun$checkVC$1(VerificationCache.scala:87)
[error] - scala.util.Try$.apply(Try.scala:213)
[error] - inox.utils.TimerStorage.runAndGetTime(Timer.scala:93)
[error] - stainless.verification.VerificationCache.checkVC(VerificationCache.scala:52)
[error] - stainless.verification.VerificationCache.checkVC$(VerificationCache.scala:42)
[error] - stainless.verification.VerificationChecker$$anon$1.checkVC(VerificationChecker.scala:345)
[error] - stainless.verification.VerificationChecker.$anonfun$checkVCs$2(VerificationChecker.scala:107)
[error] - scala.concurrent.Future$.$anonfun$traverse$1(Future.scala:850)
[error] - scala.collection.TraversableOnce.$anonfun$foldLeft$1(TraversableOnce.scala:160)
[error] - scala.collection.TraversableOnce.$anonfun$foldLeft$1$adapted(TraversableOnce.scala:160)
[error] - scala.collection.Iterator.foreach(Iterator.scala:941)
[error] - scala.collection.Iterator.foreach$(Iterator.scala:941)
[error] - scala.collection.AbstractIterator.foreach(Iterator.scala:1429)
[error] - scala.collection.IterableLike.foreach(IterableLike.scala:74)
[error] - scala.collection.IterableLike.foreach$(IterableLike.scala:73)
[error] - scala.collection.AbstractIterable.foreach(Iterable.scala:56)
[error] - scala.collection.TraversableOnce.foldLeft(TraversableOnce.scala:160)
[error] - scala.collection.TraversableOnce.foldLeft$(TraversableOnce.scala:158)
[error] - scala.collection.AbstractTraversable.foldLeft(Traversable.scala:108)
[error] - scala.concurrent.Future$.traverse(Future.scala:850)
[error] - stainless.verification.VerificationChecker.checkVCs(VerificationChecker.scala:97)
[error] - stainless.verification.VerificationChecker.checkVCs$(VerificationChecker.scala:90)
[error] - stainless.verification.VerificationChecker$Checker$1.checkVCs(VerificationChecker.scala:336)
[error] - stainless.verification.VerificationChecker.verify(VerificationChecker.scala:81)
[error] - stainless.verification.VerificationChecker.verify$(VerificationChecker.scala:77)
[error] - stainless.verification.VerificationChecker$Checker$1.verify(VerificationChecker.scala:336)
[error] - stainless.verification.VerificationChecker$.verify(VerificationChecker.scala:350)
[error] - stainless.verification.VerificationRun.execute(VerificationComponent.scala:118)
[error] - stainless.verification.VerificationRun.execute(VerificationComponent.scala:49)
[error] - stainless.ComponentRun.apply(Component.scala:105)
[error] - stainless.ComponentRun.apply$(Component.scala:97)
[error] - stainless.verification.VerificationRun.apply(VerificationComponent.scala:49)
[error] - stainless.frontend.SplitCallBack.$anonfun$processFunctionsSymbols$2(SplitCallBack.scala:190)
[error] - scala.collection.TraversableLike.$anonfun$map$1(TraversableLike.scala:238)
[error] - scala.collection.immutable.List.foreach(List.scala:392)
[error] - scala.collection.TraversableLike.map(TraversableLike.scala:238)
[error] - scala.collection.TraversableLike.map$(TraversableLike.scala:231)
[error] - scala.collection.immutable.List.map(List.scala:298)
[error] - stainless.frontend.SplitCallBack.processFunctionsSymbols(SplitCallBack.scala:189)
[error] - stainless.frontend.SplitCallBack.$anonfun$processFunctions$5(SplitCallBack.scala:164)
[error] - stainless.extraction.utils.ConcurrentCache.getOrElseUpdate(ConcurrentCaches.scala:15)
[error] - stainless.frontend.SplitCallBack.processFunctions(SplitCallBack.scala:164)
[error] - stainless.frontend.SplitCallBack.$anonfun$processSymbols$4(SplitCallBack.scala:149)
[error] - stainless.frontend.SplitCallBack.$anonfun$processSymbols$4$adapted(SplitCallBack.scala:148)
[error] - scala.collection.Iterator.foreach(Iterator.scala:941)
[error] - scala.collection.Iterator.foreach$(Iterator.scala:941)
[error] - scala.collection.AbstractIterator.foreach(Iterator.scala:1429)
[error] - scala.collection.MapLike$DefaultKeySet.foreach(MapLike.scala:181)
[error] - stainless.frontend.SplitCallBack.processSymbols(SplitCallBack.scala:148)
[error] - stainless.frontend.SplitCallBack.endExtractions(SplitCallBack.scala:70)
[error] - stainless.frontends.scalac.StainlessPluginComponent.onRun(StainlessPlugin.scala:117)
[error] - stainless.frontends.scalac.StainlessExtraction$Phase.run(StainlessExtraction.scala:45)
[error] - scala.tools.nsc.Global$Run.compileUnitsInternal(Global.scala:1503)
[error] - scala.tools.nsc.Global$Run.compileUnits(Global.scala:1487)
[error] - scala.tools.nsc.Global$Run.compileSources(Global.scala:1480)
[error] - scala.tools.nsc.Global$Run.compile(Global.scala:1606)
[error] - xsbt.CachedCompiler0.run(CompilerInterface.scala:153)
[error] - xsbt.CachedCompiler0.run(CompilerInterface.scala:125)
[error] - xsbt.CompilerInterface.run(CompilerInterface.scala:39)
[error] - java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
[error] - java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
[error] - java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
[error] - java.base/java.lang.reflect.Method.invoke(Method.java:566)
[error] - sbt.internal.inc.AnalyzingCompiler.call(AnalyzingCompiler.scala:248)
[error] - sbt.internal.inc.AnalyzingCompiler.compile(AnalyzingCompiler.scala:122)
[error] - sbt.internal.inc.AnalyzingCompiler.compile(AnalyzingCompiler.scala:95)
[error] - sbt.internal.inc.MixedAnalyzingCompiler.$anonfun$compile$4(MixedAnalyzingCompiler.scala:91)
[error] - scala.runtime.java8.JFunction0$mcV$sp.apply(JFunction0$mcV$sp.java:23)
[error] - sbt.internal.inc.MixedAnalyzingCompiler.timed(MixedAnalyzingCompiler.scala:186)
[error] - sbt.internal.inc.MixedAnalyzingCompiler.$anonfun$compile$3(MixedAnalyzingCompiler.scala:82)
[error] - sbt.internal.inc.MixedAnalyzingCompiler.$anonfun$compile$3$adapted(MixedAnalyzingCompiler.scala:77)
[error] - sbt.internal.inc.JarUtils$.withPreviousJar(JarUtils.scala:215)
[error] - sbt.internal.inc.MixedAnalyzingCompiler.compileScala$1(MixedAnalyzingCompiler.scala:77)
[error] - sbt.internal.inc.MixedAnalyzingCompiler.compile(MixedAnalyzingCompiler.scala:146)
[error] - sbt.internal.inc.IncrementalCompilerImpl.$anonfun$compileInternal$1(IncrementalCompilerImpl.scala:343)
[error] - sbt.internal.inc.IncrementalCompilerImpl.$anonfun$compileInternal$1$adapted(IncrementalCompilerImpl.scala:343)
[error] - sbt.internal.inc.Incremental$.doCompile(Incremental.scala:120)
[error] - sbt.internal.inc.Incremental$.$anonfun$compile$4(Incremental.scala:100)
[error] - sbt.internal.inc.IncrementalCommon.recompileClasses(IncrementalCommon.scala:180)
[error] - sbt.internal.inc.IncrementalCommon.cycle(IncrementalCommon.scala:98)
[error] - sbt.internal.inc.Incremental$.$anonfun$compile$3(Incremental.scala:102)
[error] - sbt.internal.inc.Incremental$.manageClassfiles(Incremental.scala:155)
[error] - sbt.internal.inc.Incremental$.compile(Incremental.scala:92)
[error] - sbt.internal.inc.IncrementalCompile$.apply(Compile.scala:75)
[error] - sbt.internal.inc.IncrementalCompilerImpl.compileInternal(IncrementalCompilerImpl.scala:348)
[error] - sbt.internal.inc.IncrementalCompilerImpl.$anonfun$compileIncrementally$1(IncrementalCompilerImpl.scala:301)
[error] - sbt.internal.inc.IncrementalCompilerImpl.handleCompilationError(IncrementalCompilerImpl.scala:168)
[error] - sbt.internal.inc.IncrementalCompilerImpl.compileIncrementally(IncrementalCompilerImpl.scala:248)
[error] - sbt.internal.inc.IncrementalCompilerImpl.compile(IncrementalCompilerImpl.scala:74)
[error] - sbt.Defaults$.compileIncrementalTaskImpl(Defaults.scala:1736)
[error] - sbt.Defaults$.$anonfun$compileIncrementalTask$1(Defaults.scala:1709)
[error] - scala.Function1.$anonfun$compose$1(Function1.scala:49)
[error] - sbt.internal.util.$tilde$greater.$anonfun$$u2219$1(TypeFunctions.scala:62)
2020-11-20 11:21:12,127 shutdown-hooks-run-all ERROR No Log4j 2 configuration file found. Using default configuration (logging only errors to the console), or user programmatically provided configurations. Set system property 'log4j2.debug' to show Log4j 2 internal initialization logging. See https://logging.apache.org/log4j/2.x/manual/configuration.html for instructions on how to configure Log4j 2
```

</details>
